# .github/workflows/update-counter.yml
name: Update Counter

on:
  schedule:
    - cron: '0 23 * 1-2 *'       # CET
    - cron: '0 23 1-24 3 *'      # March CET
    - cron: '0 22,23 25-31 3 *'  # March CET/CEST
    - cron: '0 22 * 4-9 *'       # CEST
    - cron: '0 22 1-24 10 *'     # October CEST
    - cron: '0 22,23 25-31 10 *' # October CEST/CET
    - cron: '0 23 * 11-12 *'     # CET
  workflow_dispatch:

permissions:
  contents: write

env:
  TZ: Europe/Madrid

jobs:
  update:
    runs-on: ubuntu-24.04
    timeout-minutes: 15

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          persist-credentials: true
          fetch-depth: 0

      - name: Actualiza la rama desde origin (ignora cualquier cambio local)
        run: |
          BRANCH="update-counter-action"
          git fetch origin $BRANCH
          git checkout $BRANCH || git checkout -b $BRANCH
          git reset --hard origin/master

      - name: Check if we should run now
        id: should_run
        shell: bash
        run: |
          current_date=$(date +%Y-%m-%d)
          
          # Check last commit date on this branch
          last_commit_date=$(git log -1 --format=%cd --date=format-local:'%Y-%m-%d' 2>/dev/null || echo "")
          
          if [ "$last_commit_date" = "$current_date" ]; then
            echo "Already ran today ($current_date). Skipping."
            echo "skip=true" >> $GITHUB_OUTPUT
          else
            echo "First run today. Proceeding..."
            echo "skip=false" >> $GITHUB_OUTPUT
          fi

      - name: Update HTML counter
        if: steps.should_run.outputs.skip == 'false'
        shell: bash
        run: |
          start_date="2025-06-13"
          current_date=$(date +%Y-%m-%d)

          # Pasar a segundos desde epoch
          start_s=$(date -d "$start_date" +%s)
          now_s=$(date -d "$current_date" +%s)

          # Dif in days (si es negativo, 0)
          diff=$(( (now_s - start_s) / 86400 ))
          if [ "$diff" -lt 0 ]; then
            diff=0
          fi

          # Reemplazar meta tag y el contador en una sola llamada a sed.
          # Usamos | como separador para no escapar /
          sed -i -E \
            -e 's|Han pasado [0-9]+ días desde el 13 de junio de 2025|Han pasado '"$diff"' días desde el 13 de junio de 2025|' \
            -e 's|<div class="counter" id="dayCounter">[0-9]+</div>|<div class="counter" id="dayCounter">'"$diff"'</div>|' \
            index.html

      - name: Commit & push changes
        if: steps.should_run.outputs.skip == 'false'
        shell: bash
        run: |
          git config user.email "action@github.com"
          git config user.name "GitHub Action"
          git add index.html

          if ! git diff --staged --quiet; then
            git commit -m "Update counter: $(date +%Y-%m-%d)"
            # Empuja a la rama concreta:
            git push origin update-counter-action --force
          else
            echo "No hay cambios para commitear."
          fi
